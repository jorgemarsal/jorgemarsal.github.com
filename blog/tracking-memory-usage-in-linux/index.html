<!DOCTYPE html>
<html>
  <head>
    <title>Tracking memory usage in Linux – Jorge Martinez – Big data and distributed systems.</title>

        <meta charset="utf-8" />
    <meta content='text/html; charset=utf-8' http-equiv='Content-Type'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0'>

    
    <meta name="description" content="When working with big data optimizing the memory footprint is important.

" />
    <meta property="og:description" content="When working with big data optimizing the memory footprint is important.

" />
    
    <meta name="author" content="Jorge Martinez" />

    
    <meta property="og:title" content="Tracking memory usage in Linux" />
    <meta property="twitter:title" content="Tracking memory usage in Linux" />
    

    <!--[if lt IE 9]>
      <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link rel="stylesheet" type="text/css" href="/blog/style.css" />
    <link rel="alternate" type="application/rss+xml" title="Jorge Martinez - Big data and distributed systems." href="/blog/feed.xml" />

    <!-- Created with Jekyll Now - http://github.com/barryclark/jekyll-now -->
  </head>

  <body>
    <div class="wrapper-masthead">
      <div class="container">
        <header class="masthead clearfix">
          <a href="/blog/" class="site-avatar"><img src="https://avatars2.githubusercontent.com/u/1408535" /></a>

          <div class="site-info">
            <h1 class="site-name"><a href="/blog/">Jorge Martinez</a></h1>
            <p class="site-description">Big data and distributed systems.</p>
          </div>

          <nav>
            <a href="/blog/">Blog</a>
            <a href="/blog/about">About</a>
          </nav>
        </header>
      </div>
    </div>

    <div id="main" role="main" class="container">
      <article class="post">
  <h1>Tracking memory usage in Linux</h1>

  <div class="entry">
    <p>When working with big data optimizing the memory footprint is important.</p>

<p>In this example we’re serializing a data frame with 50 million elements using R’s native <code class="highlighter-rouge">serialize</code> function:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>df &lt;- data.frame(runif(50e6,1,10))
ser &lt;- serialize(df,NULL)
</code></pre>
</div>

<p>Each element is a double that takes 8 bytes. If we do the math the data frame should be 400MB (50M elements, 8byte each). The serialized version should be around 400MB too. However if we run that code and check the memory usage we see the following:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ cat /proc/15155/status |grep Vm
...
VmHWM:	 1207792 kB
VmRSS:	  817272 kB
</code></pre>
</div>

<p><code class="highlighter-rouge">VmRSS</code> is the resident memory and in this case it’s around 800MB as we’d expect. However the peak memory usage (<code class="highlighter-rouge">VmHWM</code>) is 1.2GB. Let’s fire up <code class="highlighter-rouge">GDB</code> and see what’s going on. The relevant R code is:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>InitMemOutPStream(&amp;out, &amp;mbs, type, version, hook, fun);
R_Serialize(object, &amp;out);
val =  CloseMemOutPStream(&amp;out);
...
return val;
</code></pre>
</div>

<p>If we set a breakpoint right after <code class="highlighter-rouge">R_serialize</code> we see that the memory usage is around 800MB, as we’d expect:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>VmRSS:	  816664 kB
</code></pre>
</div>

<p>However is we step into <code class="highlighter-rouge">CloseMemOutPStream</code> we see this:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>PROTECT(val = allocVector(RAWSXP, mb-&gt;count));
memcpy(RAW(val), mb-&gt;buf, mb-&gt;count);
free_mem_buffer(mb);
</code></pre>
</div>

<p>The code is allocating a whole new buffer and copying the serialized object there. If we set a breakpoint just before <code class="highlighter-rouge">free</code>, the memory usage at that point is 1.2GB.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>VmRSS:	 1207384 kB
</code></pre>
</div>

<h3 id="optimizing-the-code">Optimizing the code</h3>

<p>Using R’s <code class="highlighter-rouge">serialize</code> we need 3x the amount of original memory (1.2GB for a 400MB) data frame, which is not acceptable.</p>

<p>Ideally we’d like to avoid the last copy and just serialize the object in a final buffer.</p>

<p>The other improvement would be to serialize the object in chunks. E.g. we could have a 10MB buffer and stream parts of the serialized object from that buffer. In this case the peak memory usage would be 410MB instead of 1.2GB!</p>

  </div>

  <div class="date">
    Written on March 16, 2015
  </div>

  
<div class="comments">
	<div id="disqus_thread"></div>
	<script type="text/javascript">

	    var disqus_shortname = 'jorgemarsal';

	    (function() {
	        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
	        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	    })();

	</script>
	<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>

</article>

    </div>

    <div class="wrapper-footer">
      <div class="container">
        <footer class="footer">
          
<a href="mailto:jorge.marsal@gmail.com"><i class="svg-icon email"></i></a>


<a href="https://github.com/jorgemarsal"><i class="svg-icon github"></i></a>

<a href="https://www.linkedin.com/in/jorgemarsal"><i class="svg-icon linkedin"></i></a>


<a href="https://www.twitter.com/jorgemarsal"><i class="svg-icon twitter"></i></a>



        </footer>
      </div>
    </div>

    
	<!-- Google Analytics -->
	<script>
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

		ga('create', 'UA-45855395-1', 'auto');
		ga('send', 'pageview', {
		  'page': '/blog/tracking-memory-usage-in-linux/',
		  'title': 'Tracking memory usage in Linux'
		});
	</script>
	<!-- End Google Analytics -->


  </body>
</html>
