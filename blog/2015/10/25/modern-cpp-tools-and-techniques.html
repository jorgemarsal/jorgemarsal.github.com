<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Modern c++ tools and techniques</title>
  <meta name="description" content="Intro">

  <link rel="stylesheet" href="/blog/css/main.css">
  <link rel="canonical" href="http://jorgemarsal.github.io/blog/2015/10/25/modern-cpp-tools-and-techniques.html">
  <link rel="alternate" type="application/rss+xml" title="Jorge Martinez" href="http://jorgemarsal.github.io/blog/feed.xml" />
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-45855395-1', 'auto');
  ga('send', 'pageview');

</script>

</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/blog/">Jorge Martinez</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/blog/about/">About</a>
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">Modern c++ tools and techniques</h1>
    <p class="post-meta">Oct 25, 2015</p>
  </header>

  <article class="post-content">
    <h3 id="intro">Intro</h3>

<p>This post is  a summary of  a <a href="http://www.slideshare.net/JorgeMartinez223/modern-c-56783426">talk</a> I gave at work. It discuses some useful c++ techniques and tooling that will help you become a more effective software engineer. All code is available on <a href="https://github.com/jorgemarsal/modern-cpp-chalktalk">Github</a>.</p>

<iframe src="//www.slideshare.net/slideshow/embed_code/key/cFcqYsDniEefh5" width="595" height="485" frameborder="0" marginwidth="0" marginheight="0" scrolling="no" style="border:1px solid #CCC; border-width:1px; margin-bottom:5px; max-width: 100%;" allowfullscreen=""> </iframe>
<div style="margin-bottom:5px"> <strong> <a href="//www.slideshare.net/JorgeMartinez223/modern-c-56783426" title="Modern c++" target="_blank">Modern c++</a> </strong> from <strong><a href="//www.slideshare.net/JorgeMartinez223" target="_blank">Jorge Martinez de Salinas</a></strong> </div>

<p>Some of the basic ideas in this post are taken for the fantastic book <a href="https://www.theeffectiveengineer.com/book">The Effective Engineer</a>:</p>

<ul>
  <li>Optimize for learning</li>
  <li>Fast iteration</li>
  <li>Good abstractions</li>
  <li>Master your craft</li>
</ul>

<h3 id="design-patterns-and-techniques">Design patterns and techniques</h3>

<p>The first thing to mention is to just design new stuff when you absolutely have too. See what’s available before starting your own design.
<code>Boost</code> and generally anything coming out of Google, Facebook etc. are good options.</p>

<p>If you have to design something from scratch using design patterns usually makes your software cleaner and more extensible.
In software engineering, a design pattern is a general reusable solution to a commonly occurring problem.
I’m gonna introduce some basic design patters that have proven quite useful.</p>

<h4 id="design-pattern-factory">Design Pattern: Factory</h4>
<p>In class-based programming, the factory method pattern is a creational pattern that uses factory methods to deal with the problem of creating objects without having to specify the exact class of the object that will be created. This is done by creating objects by calling a factory method rather than by calling a constructor.</p>

<p>As an example, let’s say we have a class to read files. We can create an interface for reading files and then create 2 classes to read local files and files from HDFS. The interesting part is that the client code can work with any file reader.
In the future we can implement new protocols or improve existing implementations without changing the client code.
We can also change the type of object we create at runtime (e.g. using environment variables).</p>

<div class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="k">class</span> <span class="nc">Reader</span> <span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
    <span class="k">virtual</span> <span class="o">~</span><span class="n">Reader</span><span class="p">()</span> <span class="p">{}</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="n">read</span><span class="p">()</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">class</span> <span class="nc">LocalReader</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Reader</span> <span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
    <span class="kt">void</span> <span class="n">read</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Reading from local FS&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="k">class</span> <span class="nc">HdfsReader</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Reader</span> <span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
    <span class="kt">void</span> <span class="n">read</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Reading from HDFS&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="k">class</span> <span class="nc">ReaderFactory</span> <span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
    <span class="k">static</span> <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">Reader</span><span class="o">&gt;</span> <span class="n">makeReader</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">type</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="s">&quot;local&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">Reader</span><span class="o">&gt;</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">LocalReader</span><span class="o">&gt;</span><span class="p">());</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="s">&quot;hdfs&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">Reader</span><span class="o">&gt;</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">HdfsReader</span><span class="o">&gt;</span><span class="p">());</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;Unsupported type&quot;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="n">reader1</span> <span class="o">=</span> <span class="n">ReaderFactory</span><span class="o">::</span><span class="n">makeReader</span><span class="p">(</span><span class="s">&quot;local&quot;</span><span class="p">);</span>
    <span class="n">reader1</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">();</span>
    <span class="k">auto</span> <span class="n">reader2</span> <span class="o">=</span> <span class="n">ReaderFactory</span><span class="o">::</span><span class="n">makeReader</span><span class="p">(</span><span class="s">&quot;hdfs&quot;</span><span class="p">);</span>
    <span class="n">reader2</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">();</span>
<span class="p">}</span></code></pre></div>

<h4 id="design-pattern-observer">Design Pattern: Observer</h4>

<p>The observer pattern is a software design pattern in which an object, called the subject, maintains a list of its dependents, called observers, and notifies them automatically of any state changes, usually by calling one of their methods. It is mainly used to implement distributed event handling systems.</p>

<p>When an event happens (in this example when we consume a line), we notify all the observers.</p>

<div class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="k">using</span> <span class="n">GenericMap</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">unordered_map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span> <span class="n">boost</span><span class="o">::</span><span class="n">any</span><span class="o">&gt;</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">INotifiable</span> <span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
    <span class="k">virtual</span> <span class="o">~</span><span class="n">INotifiable</span><span class="p">()</span> <span class="p">{}</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="n">onEvent</span><span class="p">(</span><span class="k">const</span> <span class="n">GenericMap</span><span class="o">&amp;</span> <span class="n">data</span><span class="p">)</span> <span class="k">const</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">class</span> <span class="nc">EventLogger</span> <span class="o">:</span> <span class="k">public</span> <span class="n">INotifiable</span> <span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
    <span class="kt">void</span> <span class="n">onEvent</span><span class="p">(</span><span class="k">const</span> <span class="n">GenericMap</span><span class="o">&amp;</span> <span class="n">data</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
        <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">text</span> <span class="o">=</span> <span class="n">boost</span><span class="o">::</span><span class="n">any_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="s">&quot;text&quot;</span><span class="p">));</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">text</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="k">class</span> <span class="nc">Reader</span> <span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
    <span class="kt">void</span> <span class="n">addObserver</span><span class="p">(</span><span class="n">INotifiable</span><span class="o">*</span> <span class="n">observer</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">observers_</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">observer</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kt">void</span> <span class="n">read</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
        <span class="n">GenericMap</span> <span class="n">map</span><span class="p">;</span>
        <span class="n">map</span><span class="p">[</span><span class="s">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="s">&quot;FYI&quot;</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">i</span> <span class="p">:</span> <span class="n">boost</span><span class="o">::</span><span class="n">irange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">observer</span><span class="p">:</span> <span class="n">observers_</span><span class="p">)</span> <span class="n">observer</span><span class="o">-&gt;</span><span class="n">onEvent</span><span class="p">(</span><span class="n">map</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
 <span class="k">private</span><span class="o">:</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">INotifiable</span><span class="o">*&gt;</span> <span class="n">observers_</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">EventLogger</span> <span class="n">ev1</span><span class="p">;</span>
    <span class="n">EventLogger</span> <span class="n">ev2</span><span class="p">;</span>
    <span class="n">Reader</span> <span class="n">r</span><span class="p">;</span>
    <span class="n">r</span><span class="p">.</span><span class="n">addObserver</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">INotifiable</span><span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ev1</span><span class="p">));</span>
    <span class="n">r</span><span class="p">.</span><span class="n">addObserver</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">INotifiable</span><span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ev2</span><span class="p">));</span>
    <span class="n">r</span><span class="p">.</span><span class="n">read</span><span class="p">();</span>
<span class="p">}</span></code></pre></div>

<h4 id="design-pattern-decorator">Design Pattern: Decorator</h4>

<p>In object-oriented programming, the decorator pattern (also known as Wrapper) is a design pattern that allows behavior to be added to an individual object, either statically or dynamically, without affecting the behavior of other objects from the same class.
Decorators are useful to add access control, logging, locking, to make a class thread safe etc.</p>

<div class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="k">class</span> <span class="nc">IDownloader</span> <span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
    <span class="k">virtual</span> <span class="o">~</span><span class="n">IDownloader</span><span class="p">()</span> <span class="p">{}</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="n">download</span><span class="p">()</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">class</span> <span class="nc">SimpleDownloader</span> <span class="o">:</span> <span class="k">public</span> <span class="n">IDownloader</span> <span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
    <span class="kt">void</span> <span class="n">download</span><span class="p">()</span> <span class="p">{</span>
       <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Downloading ...&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">};</span>

<span class="k">class</span> <span class="nc">LoggingDownloader</span> <span class="o">:</span> <span class="k">public</span> <span class="n">IDownloader</span> <span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
    <span class="n">LoggingDownloader</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">IDownloader</span><span class="o">&gt;</span> <span class="n">downloader</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">downloader_</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">downloader</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kt">void</span> <span class="n">download</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;begin log&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
        <span class="n">downloader_</span><span class="o">-&gt;</span><span class="n">download</span><span class="p">();</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;end log&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>
 <span class="k">private</span><span class="o">:</span>
    <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">IDownloader</span><span class="o">&gt;</span> <span class="n">downloader_</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="n">simpleDownloader</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">IDownloader</span><span class="o">&gt;</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">SimpleDownloader</span><span class="o">&gt;</span><span class="p">()));</span>
    <span class="k">auto</span> <span class="n">loggingDownloader</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">IDownloader</span><span class="o">&gt;</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">LoggingDownloader</span><span class="o">&gt;</span><span class="p">(</span>
            <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">IDownloader</span><span class="o">&gt;</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">SimpleDownloader</span><span class="o">&gt;</span><span class="p">()))));</span>
    <span class="n">simpleDownloader</span><span class="o">-&gt;</span><span class="n">download</span><span class="p">();</span>
    <span class="n">loggingDownloader</span><span class="o">-&gt;</span><span class="n">download</span><span class="p">();</span>
<span class="p">}</span></code></pre></div>

<p>So far we’ve talked about design patterns. Now I’d like to switch gears and talk about some techniques.</p>

<h4 id="technique-smart-pointers">Technique: Smart pointers</h4>

<p>Memory management in c++ is hard. It’s easy to forget a delete or make a mistake about the lifetime of object and introduce a memory-related bug.</p>

<p>Smart pointers alleviate many of the problems with ‘raw’ pointers, mainly forgetting to delete the object and leaking memory, even in the presence of exceptions. There are many types of smart pointers but the main ones are <code>unique_ptr</code> and <code>shared_ptr</code> for unique and shared ownership respectively.</p>

<div class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="k">class</span> <span class="nc">A</span> <span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
    <span class="o">~</span><span class="n">A</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;In destructor&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
   <span class="k">auto</span> <span class="n">ptr1</span><span class="p">(</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span><span class="p">());</span>
   <span class="c1">// auto ptr2 = ptr1;  // doesn&#39;t compile</span>

   <span class="k">auto</span> <span class="n">ptr3</span><span class="p">(</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span><span class="p">());</span>
   <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">ptr3</span><span class="p">.</span><span class="n">use_count</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
   <span class="k">auto</span> <span class="n">ptr4</span> <span class="o">=</span> <span class="n">ptr3</span><span class="p">;</span>
   <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">ptr3</span><span class="p">.</span><span class="n">use_count</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="p">}</span></code></pre></div>

<h4 id="technique-c1114-features">Technique: c++11/14 features</h4>

<p>c++11 and 14 bring useful new language features. Some of the most interesting ones are:</p>

<ul>
  <li>auto: less typing</li>
  <li>lambda: ability to define functions inside other functions.</li>
  <li>move semantics: avoids copies, higher efficiency</li>
  <li>…</li>
</ul>

<div class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="n">myvec</span> <span class="o">=</span> <span class="p">{</span><span class="err">“</span><span class="n">hola</span><span class="err">”</span><span class="p">,</span><span class="err">”</span><span class="n">adios</span><span class="err">”</span><span class="p">};</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">myvec</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="k">auto</span> <span class="n">anothervec</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">myvec</span><span class="p">);</span>
    <span class="n">atomic</span><span class="o">&lt;</span><span class="kt">uint64_t</span><span class="o">&gt;</span> <span class="n">counter</span><span class="p">;</span>
    <span class="n">counter</span><span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

    <span class="k">auto</span> <span class="n">incr</span> <span class="o">=</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">]</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">i</span> <span class="p">:</span> <span class="n">boost</span><span class="o">::</span><span class="n">irange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1000000</span><span class="p">))</span> <span class="p">{</span>
            <span class="o">++</span><span class="n">counter</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">};</span>

    <span class="kr">thread</span> <span class="n">t1</span><span class="p">(</span><span class="n">incr</span><span class="p">);</span>
    <span class="kr">thread</span> <span class="n">t2</span><span class="p">(</span><span class="n">incr</span><span class="p">);</span>

    <span class="n">t1</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
    <span class="n">t2</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>

    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">counter</span><span class="p">.</span><span class="n">load</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></code></pre></div>

<h4 id="technique-boost-anyvariant">Technique: boost any/variant</h4>

<p>Variants offer a simple solution for manipulating an object that can hold different types in a uniform manner. Whereas standard containers such as std::vector may be thought of as “multi-value, single type,” variant is “multi-type, single value.”</p>

<div class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="k">class</span> <span class="nc">LoggingVisitor</span> <span class="o">:</span> <span class="k">public</span> <span class="n">boost</span><span class="o">::</span><span class="n">static_visitor</span><span class="o">&lt;&gt;</span>
<span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
    <span class="kt">void</span> <span class="k">operator</span><span class="p">()(</span><span class="k">const</span> <span class="kt">int</span><span class="o">&amp;</span> <span class="n">i</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
       <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Visiting int&quot;</span> <span class="o">&lt;&lt;</span><span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kt">void</span> <span class="k">operator</span><span class="p">()(</span><span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">str</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
       <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Visiting string&quot;</span> <span class="o">&lt;&lt;</span><span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">boost</span><span class="o">::</span><span class="n">variant</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">variant1</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
    <span class="k">auto</span> <span class="n">int1</span> <span class="o">=</span> <span class="n">boost</span><span class="o">::</span><span class="n">get</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">variant1</span><span class="p">);</span>  <span class="c1">// ok</span>
    <span class="n">try</span> <span class="p">{</span>
        <span class="k">auto</span> <span class="n">str1</span> <span class="o">=</span>
            <span class="n">boost</span><span class="o">::</span><span class="n">get</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="p">(</span><span class="n">variant1</span><span class="p">);</span> <span class="c1">//fails</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="k">const</span> <span class="n">boost</span><span class="o">::</span><span class="n">bad_get</span><span class="o">&amp;</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;fails&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">boost</span><span class="o">::</span><span class="n">apply_visitor</span><span class="p">(</span><span class="n">LoggingVisitor</span><span class="p">(),</span> <span class="n">variant1</span><span class="p">);</span>

    <span class="n">boost</span><span class="o">::</span><span class="n">variant</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">variant2</span> <span class="o">=</span> <span class="s">&quot;hola&quot;</span><span class="p">;</span>
    <span class="n">boost</span><span class="o">::</span><span class="n">apply_visitor</span><span class="p">(</span><span class="n">LoggingVisitor</span><span class="p">(),</span> <span class="n">variant2</span><span class="p">);</span>
<span class="p">}</span></code></pre></div>

<p>If your function needs to return any type use <code>boost::any</code>. The advantage of <code>boost::any</code> vs a <code>void *</code> pointer is type safety.</p>

<div class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="cp">#include &lt;boost/any.hpp&gt;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">boost</span><span class="o">::</span><span class="n">any</span> <span class="n">any1</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">uint64_t</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
    <span class="kt">uint64_t</span> <span class="n">int1</span> <span class="o">=</span> <span class="n">boost</span><span class="o">::</span><span class="n">any_cast</span><span class="o">&lt;</span><span class="kt">uint64_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">any1</span><span class="p">);</span>  <span class="c1">// ok</span>

    <span class="n">boost</span><span class="o">::</span><span class="n">any</span> <span class="n">any2</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">uint64_t</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
    <span class="n">try</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">int2</span> <span class="o">=</span> <span class="n">boost</span><span class="o">::</span><span class="n">any_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">any2</span><span class="p">);</span>  <span class="c1">// fails</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="k">const</span> <span class="n">boost</span><span class="o">::</span><span class="n">bad_any_cast</span><span class="o">&amp;</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;fail&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></div>

<p>With this we conclude the design section. The following sections gives an overview of some useful c++ tools.</p>

<h3 id="tools">Tools</h3>

<h4 id="clang">Clang</h4>
<p><code>Clang</code> is a nice alternative to <code>g++</code>. It gives you faster compilation times and more meaningful errors.
It also comes with many useful tools that we’ll explore in later sections.</p>

<h4 id="use-cmakescons-for-building">Use cmake/scons for building</h4>
<p>Instead of using raw Makefiles you can use something more modern like <code>Cmake</code> or <code>Scons</code>.
Those tools give you cross-platform builds, automatic discovery and configuration of the toolchain, automatic dependency management, debug/release modes and many other useful features.</p>

<p>I’m not saying all those things can’t be done with make, but that involves a significant effort.</p>

<h4 id="debugging">Debugging</h4>

<p>Probably you’ll spend a lot of time debugging so being familiar with GDB it’s very important.
Oftentimes you’re better off with a graphical debugger that uses GDB under the hood.</p>

<h4 id="testing-with-google-test">Testing with Google Test</h4>

<p>Testing is a high leverage activity. It ensures the system is
working as expected and gives you confidence to add new features or make changes.</p>

<p>Test small functionality with unit testing and have integration and performance testing as well.</p>

<div class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="k">class</span> <span class="nc">Calculator</span> <span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
    <span class="k">static</span> <span class="kt">uint64_t</span> <span class="n">sum</span><span class="p">(</span><span class="k">const</span> <span class="kt">uint64_t</span> <span class="n">op1</span><span class="p">,</span> <span class="k">const</span> <span class="kt">uint64_t</span> <span class="n">op2</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">op1</span> <span class="o">+</span> <span class="n">op2</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">static</span> <span class="kt">uint64_t</span> <span class="n">mul</span><span class="p">(</span><span class="k">const</span> <span class="kt">uint64_t</span> <span class="n">op1</span><span class="p">,</span> <span class="k">const</span> <span class="kt">uint64_t</span> <span class="n">op2</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">op1</span> <span class="o">*</span> <span class="n">op2</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">MyConfig</span> <span class="p">{</span>
    <span class="n">MyConfig</span><span class="p">(</span><span class="k">const</span> <span class="kt">uint64_t</span> <span class="n">op1</span><span class="p">,</span>
             <span class="k">const</span> <span class="kt">uint64_t</span> <span class="n">op2</span><span class="p">)</span> <span class="o">:</span> <span class="n">op1_</span><span class="p">(</span><span class="n">op1</span><span class="p">),</span> <span class="n">op2_</span><span class="p">(</span><span class="n">op2</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">}</span>
    <span class="k">const</span> <span class="kt">uint64_t</span> <span class="n">op1_</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">uint64_t</span> <span class="n">op2_</span><span class="p">;</span>
<span class="p">};</span>

<span class="o">::</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span> <span class="k">operator</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="o">::</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">,</span> <span class="k">const</span> <span class="n">MyConfig</span><span class="o">&amp;</span> <span class="n">config</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;op1: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">config</span><span class="p">.</span><span class="n">op1_</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; op2: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">config</span><span class="p">.</span><span class="n">op2_</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">class</span> <span class="nc">MyTest</span> <span class="o">:</span> <span class="k">public</span> <span class="o">::</span><span class="n">testing</span><span class="o">::</span><span class="n">TestWithParam</span><span class="o">&lt;</span><span class="n">MyConfig</span><span class="o">&gt;</span> <span class="p">{</span>

<span class="p">};</span>

<span class="n">TEST_P</span><span class="p">(</span><span class="n">MyTest</span><span class="p">,</span> <span class="n">Sum</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">const</span> <span class="n">MyConfig</span><span class="o">&amp;</span> <span class="n">conf</span> <span class="o">=</span> <span class="n">GetParam</span><span class="p">();</span>
    <span class="n">EXPECT_EQ</span><span class="p">(</span><span class="n">Calculator</span><span class="o">::</span><span class="n">sum</span><span class="p">(</span><span class="n">conf</span><span class="p">.</span><span class="n">op1_</span><span class="p">,</span><span class="n">conf</span><span class="p">.</span><span class="n">op2_</span><span class="p">),</span> <span class="n">conf</span><span class="p">.</span><span class="n">op1_</span> <span class="o">+</span> <span class="n">conf</span><span class="p">.</span><span class="n">op2_</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">TEST_P</span><span class="p">(</span><span class="n">MyTest</span><span class="p">,</span> <span class="n">Multiply</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">const</span> <span class="n">MyConfig</span><span class="o">&amp;</span> <span class="n">conf</span> <span class="o">=</span> <span class="n">GetParam</span><span class="p">();</span>
    <span class="n">EXPECT_EQ</span><span class="p">(</span><span class="n">Calculator</span><span class="o">::</span><span class="n">mul</span><span class="p">(</span><span class="n">conf</span><span class="p">.</span><span class="n">op1_</span><span class="p">,</span><span class="n">conf</span><span class="p">.</span><span class="n">op2_</span><span class="p">),</span> <span class="n">conf</span><span class="p">.</span><span class="n">op1_</span> <span class="o">*</span> <span class="n">conf</span><span class="p">.</span><span class="n">op2_</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">INSTANTIATE_TEST_CASE_P</span><span class="p">(</span><span class="n">MyValues</span><span class="p">,</span> <span class="n">MyTest</span><span class="p">,</span> <span class="o">::</span><span class="n">testing</span><span class="o">::</span><span class="n">Values</span><span class="p">(</span>
    <span class="n">MyConfig</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span>
    <span class="n">MyConfig</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
<span class="p">));</span></code></pre></div>

<p>Some useful Google Test tips are:</p>

<ul>
  <li>Use parameterized tests</li>
  <li>Run only some tests with <code>--gtest-filter=&lt;pattern&gt;</code></li>
  <li>List all tests: <code>--gtest_list_tests</code></li>
  <li>Exclude certain tests by prepending <code>DISABLED_</code> to the test name</li>
</ul>

<h4 id="mocking">Mocking</h4>

<p>Mocks are useful when you want to test a component but its dependencies haven’t been implemented yet or if the dependencies are complex to set up (e.g. an external HTTP service).</p>

<div class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="cp">#include &lt;gmock/gmock.h&gt;</span>
<span class="cp">#include &lt;gtest/gtest.h&gt;</span>

<span class="k">class</span> <span class="nc">ICalculator</span> <span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
    <span class="k">virtual</span> <span class="kt">uint64_t</span> <span class="n">sum</span> <span class="p">(</span><span class="k">const</span> <span class="kt">uint64_t</span> <span class="n">op1</span><span class="p">,</span> <span class="k">const</span> <span class="kt">uint64_t</span> <span class="n">op2</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">virtual</span> <span class="kt">uint64_t</span> <span class="n">mul</span> <span class="p">(</span><span class="k">const</span> <span class="kt">uint64_t</span> <span class="n">op1</span><span class="p">,</span> <span class="k">const</span> <span class="kt">uint64_t</span> <span class="n">op2</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">class</span> <span class="nc">OnlineCalculator</span> <span class="o">:</span> <span class="k">public</span> <span class="n">ICalculator</span> <span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
    <span class="kt">uint64_t</span> <span class="n">sum</span><span class="p">(</span><span class="k">const</span> <span class="kt">uint64_t</span> <span class="n">op1</span><span class="p">,</span> <span class="k">const</span> <span class="kt">uint64_t</span> <span class="n">op2</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;Unimplemented&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kt">uint64_t</span> <span class="n">mul</span><span class="p">(</span><span class="k">const</span> <span class="kt">uint64_t</span> <span class="n">op1</span><span class="p">,</span> <span class="k">const</span> <span class="kt">uint64_t</span> <span class="n">op2</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;Unimplemented&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="k">class</span> <span class="nc">MockCalculator</span> <span class="o">:</span> <span class="k">public</span> <span class="n">ICalculator</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
    <span class="n">MOCK_METHOD2</span><span class="p">(</span><span class="n">sum</span><span class="p">,</span> <span class="kt">uint64_t</span><span class="p">(</span><span class="k">const</span> <span class="kt">uint64_t</span><span class="p">,</span> <span class="k">const</span> <span class="kt">uint64_t</span><span class="p">));</span>
    <span class="n">MOCK_METHOD2</span><span class="p">(</span><span class="n">mul</span><span class="p">,</span> <span class="kt">uint64_t</span><span class="p">(</span><span class="k">const</span> <span class="kt">uint64_t</span><span class="p">,</span> <span class="k">const</span> <span class="kt">uint64_t</span><span class="p">));</span>
<span class="p">};</span>

<span class="n">TEST</span><span class="p">(</span><span class="n">testcase</span><span class="p">,</span> <span class="n">test</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">using</span> <span class="o">::</span><span class="n">testing</span><span class="o">::</span><span class="n">Return</span><span class="p">;</span>
    <span class="k">using</span> <span class="o">::</span><span class="n">testing</span><span class="o">::</span><span class="n">_</span><span class="p">;</span>
    <span class="n">MockCalculator</span> <span class="n">c</span><span class="p">;</span>
    <span class="n">EXPECT_CALL</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">sum</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)).</span><span class="n">Times</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="n">WillOnce</span><span class="p">(</span><span class="n">Return</span><span class="p">(</span><span class="mi">3</span><span class="p">)).</span><span class="n">WillOnce</span><span class="p">(</span><span class="n">Return</span><span class="p">(</span><span class="mi">7</span><span class="p">));</span>
    <span class="n">EXPECT_CALL</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">mul</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)).</span><span class="n">Times</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="n">WillOnce</span><span class="p">(</span><span class="n">Return</span><span class="p">(</span><span class="mi">2</span><span class="p">)).</span><span class="n">WillOnce</span><span class="p">(</span><span class="n">Return</span><span class="p">(</span><span class="mi">12</span><span class="p">));</span>

    <span class="n">EXPECT_EQ</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="mi">3</span><span class="p">);</span>
    <span class="n">EXPECT_EQ</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="mi">7</span><span class="p">);</span>

    <span class="n">EXPECT_EQ</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="mi">2</span><span class="p">);</span>
    <span class="n">EXPECT_EQ</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">mul</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="mi">12</span><span class="p">);</span>
<span class="p">}</span></code></pre></div>

<p>Remember we mentioned Clang comes with nice tools? Here are 2 examples.</p>

<h4 id="address-sanitizer">Address Sanitizer</h4>

<p>Address Sanitizer is a fast memory error detector. It consists of a compiler instrumentation module and a run-time library. The tool can detect the following types of bugs:</p>

<ul>
  <li>Out-of-bounds accesses to heap, stack and globals</li>
  <li>Use-after-free</li>
  <li>Use-after-return (to some extent)</li>
  <li>Double-free, invalid free</li>
  <li>Memory leaks (experimental)</li>
</ul>

<p>Typical slowdown introduced by Address Sanitizer is 2x which is way faster than Valgrind.</p>

<div class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
   <span class="kt">int</span> <span class="n">array</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
   <span class="n">array</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mi">123</span><span class="p">;</span>
<span class="p">}</span></code></pre></div>

<p>In this example we’re making an out-of-bounds access. Without Adress Sanitizer many times this error goes unnoticed.
However when compiling with Address Sanitizer support we get the following warning:</p>

<pre><code>[32, 72) 'array' &lt;== Memory access at offset 72 overflows this variable
</code></pre>

<h4 id="thread-sanitizer">Thread Sanitizer</h4>

<p>ThreadSanitizer is a tool that detects data races. It consists of a compiler instrumentation module and a run-time library. Typical slowdown introduced by ThreadSanitizer is about 5x-15x. Typical memory overhead is about 5x-10x.</p>

<div class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
   <span class="kt">uint64_t</span> <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="k">auto</span> <span class="n">incr</span> <span class="o">=</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">]</span> <span class="p">()</span> <span class="p">{</span>
       <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">i</span> <span class="p">:</span> <span class="n">boost</span><span class="o">::</span><span class="n">irange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1000000</span><span class="p">))</span> <span class="p">{</span>
           <span class="o">++</span><span class="n">counter</span><span class="p">;</span>
       <span class="p">}</span>
   <span class="p">};</span>

   <span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="n">t1</span><span class="p">(</span><span class="n">incr</span><span class="p">);</span>
   <span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="n">t2</span><span class="p">(</span><span class="n">incr</span><span class="p">);</span>

   <span class="n">t1</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
   <span class="n">t2</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>

   <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">counter</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></code></pre></div>

<p>In this example there’s a race condition and Thread Sanitizer gives us the following warning:</p>

<pre><code>WARNING: ThreadSanitizer: data race (pid=79195)
Write of size 8 at 0x7fffa50a2a60 by thread T2:
Previous write of size 8 at 0x7fffa50a2a60 by thread T1:
</code></pre>

<p>To fix the previous exam[le we can make <code>incr</code> atomic or use a mutex.</p>

<h4 id="facebook-folly">Facebook Folly</h4>
<p>Folly is a collection of reusable C++ library artifacts developed and used at Facebook.
Some examples are faster replacements for <code>std::string</code> and <code>std::vector</code> and a useful benchmarking module:</p>

<div class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="n">BENCHMARK</span><span class="p">(</span><span class="n">copy</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">vector</span><span class="o">&lt;</span><span class="kt">uint64_t</span><span class="o">&gt;</span> <span class="n">v</span><span class="p">;</span>
    <span class="n">v</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="mi">128</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">);</span>
    <span class="n">FOR_EACH_RANGE</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">vector</span><span class="o">&lt;</span><span class="kt">uint64_t</span><span class="o">&gt;</span> <span class="n">v2</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">BENCHMARK</span><span class="p">(</span><span class="n">move</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">vector</span><span class="o">&lt;</span><span class="kt">uint64_t</span><span class="o">&gt;</span> <span class="n">v</span><span class="p">;</span>
    <span class="n">v</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="mi">128</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">);</span>
    <span class="n">FOR_EACH_RANGE</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">vector</span><span class="o">&lt;</span><span class="kt">uint64_t</span><span class="o">&gt;</span> <span class="n">v2</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">v</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">runBenchmarks</span><span class="p">();</span>
<span class="p">}</span></code></pre></div>

<h4 id="google-performance-tools">Google Performance Tools</h4>

<p>Gperftools is useful to find out where the program spends cycles. It accounts for network and IO time as well.
You can generate a profile using:</p>

<pre><code>$ CPUPROFILE=/tmp/$PROFILENAME.prof LD_PRELOAD=/usr/local/lib/libprofiler.so:/usr/lib/libtcmalloc.so $BINARY $ARGS
$ pprof --gv $BINARY /tmp/$PROFILENAME.prof
</code></pre>

<p>This is an example profile:
<img src="/blog/assets/pprof.png" alt="gperftools" /></p>

<h4 id="linting">Linting</h4>
<p><code>cpplint.py</code> gives a lot useful warnings about code style and common c++ errors:</p>

<pre><code>$ cpplint.py &lt;files&gt;
</code></pre>

<h4 id="docker">Docker</h4>
<p>Docker gives you a single environment in which you have total control over dependencies and versions. And the best part is that the environment will be the same (or very similar) in development and production.</p>

<p>To “Dockerize” an application all you need to do is to create a Dockerfile. For static binaries this is really simple:</p>

<pre><code>// Dockerfile
FROM centos
COPY myapp /tmp/
CMD /tmp/myapp
</code></pre>

<p>We can build the Docker image with:</p>

<pre><code>$ docker build -t jorgemarsal/myapp:0.0.1 .
</code></pre>

<p>And run it with:</p>

<pre><code>$ docker run --name myapp jorgemarsal/myapp:0.0.1
</code></pre>

<h4 id="continous-integration-jenkins">Continous Integration (Jenkins)</h4>
<p>All the tooling presented before should be integrated with CI:</p>

<ul>
  <li>Check code for memory and threading problems (asan/tsan)</li>
  <li>Run test suites (gtest)</li>
  <li>Check for style, linting</li>
  <li>Coverage</li>
  <li>Metrics/ track improvements</li>
  <li>…</li>
</ul>

<h3 id="conclusions">Conclusions</h3>

<p>In this post we’ve described a few useful c++ tools and techniques.
Other topics that are fundamental but we didn’t discuss are:</p>

<ul>
  <li>Mastering a scripting language (e.g. Python)</li>
  <li>Mastering the command line</li>
  <li>Mastering your IDE</li>
  <li>Automating everything</li>
  <li>Shortening release cycles (e.g. via continuous delivery)</li>
</ul>

  </article>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Jorge Martinez</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <li>Jorge Martinez</li>
          <li><a href="mailto:jorge.marsal@gmail.com">jorge.marsal@gmail.com</a></li>
        </ul>
      </div>

      <div class="footer-col  footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/jorgemarsal">
              <span class="icon  icon--github">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                </svg>
              </span>

              <span class="username">jorgemarsal</span>
            </a>
          </li>
          

          
          <li>
            <a href="https://twitter.com/jorgemarsal">
              <span class="icon  icon--twitter">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                  c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
                </svg>
              </span>

              <span class="username">jorgemarsal</span>
            </a>
          </li>
          
        </ul>
      </div>

      <div class="footer-col  footer-col-3">
        <p class="text"></p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
