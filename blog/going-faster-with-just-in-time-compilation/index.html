<!DOCTYPE html>
<html>
  <head>
    <title>Going faster with Just-In-Time compilation – Jorge Martinez – Big data and distributed systems.</title>

        <meta charset="utf-8" />
    <meta content='text/html; charset=utf-8' http-equiv='Content-Type'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0'>

    
    <meta name="description" content="This post is about code optimization using Just-In-Time compilation. The main insight is that there is a tradeoff between generality and performance. In other words if you want to make things generic they will be slower than a specialized solution.

" />
    <meta property="og:description" content="This post is about code optimization using Just-In-Time compilation. The main insight is that there is a tradeoff between generality and performance. In other words if you want to make things generic they will be slower than a specialized solution.

" />
    
    <meta name="author" content="Jorge Martinez" />

    
    <meta property="og:title" content="Going faster with Just-In-Time compilation" />
    <meta property="twitter:title" content="Going faster with Just-In-Time compilation" />
    

    <!--[if lt IE 9]>
      <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link rel="stylesheet" type="text/css" href="/blog/style.css" />
    <link rel="alternate" type="application/rss+xml" title="Jorge Martinez - Big data and distributed systems." href="/blog/feed.xml" />

    <!-- Created with Jekyll Now - http://github.com/barryclark/jekyll-now -->
  </head>

  <body>
    <div class="wrapper-masthead">
      <div class="container">
        <header class="masthead clearfix">
          <a href="/blog/" class="site-avatar"><img src="https://avatars2.githubusercontent.com/u/1408535" /></a>

          <div class="site-info">
            <h1 class="site-name"><a href="/blog/">Jorge Martinez</a></h1>
            <p class="site-description">Big data and distributed systems.</p>
          </div>

          <nav>
            <a href="/blog/">Blog</a>
            <a href="/blog/about">About</a>
          </nav>
        </header>
      </div>
    </div>

    <div id="main" role="main" class="container">
      <article class="post">
  <h1>Going faster with Just-In-Time compilation</h1>

  <div class="entry">
    <p>This post is about code optimization using <a href="https://en.wikipedia.org/wiki/Just-in-time_compilation">Just-In-Time compilation</a>. The main insight is that there is a tradeoff between generality and performance. In other words if you want to make things generic they will be slower than a specialized solution.</p>

<p>Let’s use an example to make things clearer. Say we’re working on an analytics DB and we want to sum 2 columns. If we code a generic solution we cannot make any assumption about the column types, the number of rows in the columns or the hardware characteristics. A generic code would then be:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>// Let’s assume the column are stored in arrays a and b
// and we want to store the result in array c
if (type == ‘double) {
    for (int i = 0; i &lt; nrows; ++i) {
        c[i] = a[i] + b[i];
    }
}
</code></pre>
</div>

<p>The compiler cannot do much to optimize this code. It has a conditional and we don’t know the value of <code class="highlighter-rouge">nrows</code> so we cannot optimize the loop.</p>

<p>However at runtime we’ll have more information (like number of rows, types, etc.) and we can leverage it to create more efficient code.  Let’s say we know the column type is double and we also know the hardware supports <a href="https://en.wikipedia.org/wiki/Streaming_SIMD_Extensions">SSE</a> instructions that can add 2 pairs of doubles in a single cycle. We can generate optimizing code on the fly like this:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>| mov eax, a
| movapd xmm0, oword [eax]  // load array a using SSE
| mov eax, b
| movapd xmm1, oword [eax]  // load array b using SSE
| addpd xmm0, xmm1              // add arrays a and b in a single cycle using SSE
| mov eax, c
| movapd oword [eax], xmm0  // store result in array c using SSE
| ret
</code></pre>
</div>

<p>You can take a look at the full code (adapted from this excellent <a href="http://blog.reverberate.org/2012/12/hello-jit-world-joy-of-simple-jits.html">example</a>) <a href="https://github.com/jorgemarsal/jitdemo/blob/master/sse.dasc">here</a>. We use <code class="highlighter-rouge">dynasm</code> to generate the machine code that performs the additions using SSE. Then we copy that machine code to a memory region marked as executable and jump to it.</p>

<p>With this optimization the performance improves dramatically. 1 million iterations of the first example run in 0.04 seconds while the second example runs in 0.002 seconds. That’s a 20X speedup!</p>

<p>This is a pretty contrived example but a generalization of this technique is extremely useful to improve performance in real world cases and companies like <a href="https://databricks.com/blog/2015/04/28/project-tungsten-bringing-spark-closer-to-bare-metal.html">Databricks</a> use it in their products.</p>

<p>Pretty cool huh?</p>


  </div>

  <div class="date">
    Written on January 14, 2016
  </div>

  
<div class="comments">
	<div id="disqus_thread"></div>
	<script type="text/javascript">

	    var disqus_shortname = 'jorgemarsal';

	    (function() {
	        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
	        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	    })();

	</script>
	<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>

</article>

    </div>

    <div class="wrapper-footer">
      <div class="container">
        <footer class="footer">
          
<a href="mailto:jorge.marsal@gmail.com"><i class="svg-icon email"></i></a>


<a href="https://github.com/jorgemarsal"><i class="svg-icon github"></i></a>

<a href="https://www.linkedin.com/in/jorgemarsal"><i class="svg-icon linkedin"></i></a>


<a href="https://www.twitter.com/jorgemarsal"><i class="svg-icon twitter"></i></a>



        </footer>
      </div>
    </div>

    
	<!-- Google Analytics -->
	<script>
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

		ga('create', 'UA-45855395-1', 'auto');
		ga('send', 'pageview', {
		  'page': '/blog/going-faster-with-just-in-time-compilation/',
		  'title': 'Going faster with Just-In-Time compilation'
		});
	</script>
	<!-- End Google Analytics -->


  </body>
</html>
